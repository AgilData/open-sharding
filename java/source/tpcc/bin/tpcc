#!/usr/bin/env ruby

# tpcc
#
# Copyright (c) 2011 CodeFutures Corporation. All rights reserved.
#

require 'fileutils'
require 'pathname'

file = File.open("tpcc.properties","r")
if(!file)
  puts "Failed to open properties file."
  exit
end

properties = Hash.new

while(line = file.gets)
  if line.eqls?("\n")
    line.gets
  end
  if line.match("#")
    line.gets
  end
  tempLine = line.split("=")
  properties[tempLine[0]] = tempLine[1]
end

flags = ""

if(properties[HOST])
    flags = "-h " + properties[HOST]
else
    puts "No host in properties"
    exit
end

if(properties[DATABASE])
  flags = flags + " -d " + properties[DATABASE]
else
  puts "No database in properties"
  exit
end

if(properties[USER])
  flags = flags + " -u " + properties[USER]
else
  puts "No user in properties"
  exit
end

if(properties[PASSWORD])
  flags = flags + " -p " + properties[PASSWORD]
else
  puts "No password in properties."
  exit
end

if(properties[WAREHOUSECOUNT])
  flags = flags + " -w " + properties[WAREHOUSECOUNT]
else
  puts "No warehouse count"
  exit
end

if(properties[CONNECTIONS])
  flags = flags + " -c " + properties[CONNECTIONS]
else
  puts "No connections in properties"
  exit
end

if(properties[RAMPUPTIME])
  flags = flags + " -r " + properties[RAMPUPTIME]
else
  puts "No rampup time in properties"
  exit
end

if(properties[DURATION])
  flags = flags + " -l " + properties[DURATION]
else
  puts "No duration specified"
  exit
end

if(properties[DRIVER])
  flags = flags + " -U " + properties[DRIVER]
else
  puts "No driver specified."
  exit
end

  

# Set the base dir. Expand path gives the absolute path of the current file, dirname gives the bin dir, and dirname again gives the parent dir.
BASEDIR = File.dirname(File.dirname(Pathname.new(__FILE__).realpath))

JAVA = "java"
CLASS = "org.opensharding.tpcc.Tpcc"
OPTIONS = "-Dfile.encoding=UTF8"
HEAPSIZE = "128m"
XMS = "-Xms16m"
XMX = "-Xmx#{HEAPSIZE}"


jars = "#{BASEDIR}/tpcc-jars/*.jar"

class_path = "-classpath #{BASEDIR}/conf:#{Dir.glob(jars).join(':')}"

cmd = [JAVA, OPTIONS, XMS, XMX, class_path, CLASS, flags].join(' ')
    
puts cmd

# Run the command. Use exec, this outputs STDOUT and STDERR for the process.
exec(cmd)
            
exit 0