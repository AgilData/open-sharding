#!/usr/bin/env ruby

# tpcc
#
# Copyright (c) 2011 CodeFutures Corporation. All rights reserved.
#

require 'fileutils'
require 'pathname'

file = File.open("/root/open-sharding/java/source/tpcc/bin/tpcc.properties","r")
if(!file)
  puts "Failed to open properties file."
  exit
end

properties = Hash.new

while(line = file.gets)

  while line.eql?("\n")
    line = file.gets
  end
  
  while line.match("#")
    line = file.gets
  end
  
  tempLine = line.split("=")
  puts tempLine
  puts tempLine[0]

  flags = ""
  
  if(tempLine[0].eql?("HOST"))
      flags = "-h " + tempLine[1]
  else
      puts "No host in properties"
      exit
  end
  
  if (tempLine[0].eql?("DATABASE"))
    flags = flags + " -d " + tempLine[1]
  else
    puts "No database in properties"
    exit
  end
  
  if(tempLine[0].eql?("USER"))
    flags = flags + " -u " + tempLine[1]
  else
    puts "No user in properties"
    exit
  end
  
  if(tempLine[0].eql?("PASSWORD"))
    flags = flags + " -p " + tempLine[1]
  else
    puts "No password in properties."
    exit
  end
  
  if(tempLine[0].eql?("WAREHOUSECOUNT"))
    flags = flags + " -w " + tempLine[1]
  else
    puts "No warehouse count"
    exit
  end
  
  if(tempLine[0].eql?("CONNECTIONS"))
    flags = flags + " -c " + tempLine[1]
  else
    puts "No connections in properties"
    exit
  end
  
  if(tempLine[0].eql?("RAMPUPTIME"))
    flags = flags + " -r " + tempLine[1]
  else
    puts "No rampup time in properties"
    exit
  end
  
  if(tempLine[0].eql?("DURATION"))
    flags = flags + " -l " + tempLine[1]
  else
    puts "No duration specified"
    exit
  end
  
  if(tempLine[0].eql?("DRIVER"))
    flags = flags + " -U " + tempLine[1]
  else
    puts "No driver specified."
    exit
  end
  
end
  

# Set the base dir. Expand path gives the absolute path of the current file, dirname gives the bin dir, and dirname again gives the parent dir.
BASEDIR = File.dirname(File.dirname(Pathname.new(__FILE__).realpath))

JAVA = "java"
CLASS = "org.opensharding.tpcc.Tpcc"
OPTIONS = "-Dfile.encoding=UTF8"
HEAPSIZE = "128m"
XMS = "-Xms16m"
XMX = "-Xmx#{HEAPSIZE}"


jars = "#{BASEDIR}/tpcc-jars/*.jar"

class_path = "-classpath #{BASEDIR}/conf:#{Dir.glob(jars).join(':')}"

cmd = [JAVA, OPTIONS, XMS, XMX, class_path, CLASS, flags].join(' ')
    
puts cmd

# Run the command. Use exec, this outputs STDOUT and STDERR for the process.
exec(cmd)
            
exit 0